 # Atomic Upgrades

    You can turn off the power anytime you want…
    Simple upgrades via HTTP
    Upgrades via external tools (e.g. package managers)
    Assembling a new deployment directory
    Atomically swapping boot configuration
    The bootversion
    The /ostree/boot directory
        Licensing for this document:

## Вы можете выключить питание в любое время…

OSTree предназначен для реализации полностью атомарных и безопасных обновлений; в более общем смысле, атомарные переходы между списками загрузочных развертываний. Если система выйдет из строя или вы отключите питание, у вас будет либо старая система, либо новая. 

## Простое обновление через HTTP

Прежде всего, самая базовая модель, которую поддерживает OSTree, - это модель, в которой он реплицирует предварительно сгенерированные деревья файловых систем с сервера по протоколу HTTP, отслеживая ровно одну ссылку, которая хранится в файле `.origin` для развертывания. Это реализует команда `ostree admin upgrade`.

Чтобы начать простое обновление, OSTree получает содержимое ссылки с удаленного сервера. Предположим, мы отслеживаем ссылку с именем `exampleos/buildmaster/x86_64-runtime`. OSTree получает URL `http://example.com/repo/refs/heads/exampleos/buildmaster/x86_64-runtime`, который содержит контрольную сумму SHA256. Это определяет дерево для развертывания, и `/etc` будет объединен с загруженным в данный момент деревом.

Если у нас нет этого коммита, мы выполняем процесс извлечения. В настоящее время (без статических дельт) для этого достаточно просто получить каждый отдельный объект, которого у нас нет, в асинхронном режиме. Другими словами, мы загружаем только измененные файлы (сжатые zlib). Контрольная сумма каждого объекта проверена и хранится в `/ostree/repo/objects/`. 

После завершения извлечения мы загрузи все объекты, необходимые для развертывания. 

## Обновления с помощью внешних инструментов (например, менеджеров пакетов)

Как упоминалось во введении, OSTree также поддерживает модель, в которой деревья файловых систем формируются на клиенте. 
Совершенно безразлично, как эти деревья генерируются; они могут быть сформированы с помощью традиционных пакетов, пакетов с сценариями после развертывания из корневого директория или построены разработчиками непосредственно из локального контроля версий и т. д.

На практическом уровне большинство менеджеров пакетов сегодня (`dpkg` и `rpm`) работают «вживую» с файловой системой, загруженной в данный момент. Вместо этого они могли бы работать с OSTree, взяв список установленных пакетов в текущем загруженном дереве и сформировав из него новую файловую систему. В следующей главе более подробно описывается, как это может работать: [Адаптация существующих систем](distributions.md).

Для целей этого раздела предположим, что у нас есть вновь сгенерированное дерево файловой системы, хранящееся в репозитории (которое разделяет хранилище с существующим загруженным деревом). 
Затем мы можем перейти к проверке его из репозитория в развертывание. 

## Сборка нового каталога развертывания

Получив коммит для развертывания, OSTree сначала выделяет для него каталог. 
Он имеет вид `/boot/loader/entries/ostree-$stateroot-$checksum.$serial.conf`. `$serial` обычно равен 0, но если данная фиксация развернута более одного раза, она будет увеличиваться. 
Это делается для того, чтобы предыдущее развертывание могло иметь конфигурацию в `/etc`, которую мы не хотим использовать или перезаписывать.

Теперь, когда у нас есть каталог развертывания, выполняется трехстороннее слияние между (по умолчанию) загруженным в данный момент развертыванием `/etc`, его конфигурацией по умолчанию и новым развертыванием (на основе его `/usr/etc`).

Как это работает:
- Файлы в текущем загруженном развертывании `/etc`, которые были изменены из `/usr/etc` по умолчанию (того же развертывания), сохраняются.
- Файлы в текущем загруженном развертывании `/etc`, которые не были изменены из `/usr/etc` по умолчанию (того же развертывания), обновляются до новых значений по умолчанию из `/usr/etc`? нового развертывания.

Проще говоря, это означает, что как только вы изменяете или добавляете файл в `/etc`, этот файл будет зафиксирован на все последующие развертывания 
(хотя есть крайний случай, когда ваша модификация в конечном итоге точно соответствует будущему файлу по умолчанию, тогда файл с этого момента будет обновляться в последующих развертываниях).

Вы можете использовать команду `ostree admin config-diff`, чтобы увидеть различия между загруженным развертыванием `/etc` и настройками по умолчанию в OSTree. 


## Атомарная замена загружаемых конфигурации 

На этом этапе был создан новый каталог развертывания как ферма жестких (hard) ссылок; работающая система осталась нетронутой, и конфигурация загрузчика осталась нетронутой. 
Мы хотим добавить это развертывание в «список развертывания».

Чтобы поддержать более общий случай, OSTree поддерживает атомарный переход между произвольными наборами развертываний с ограничением, что текущее загруженное развертывание всегда должно быть в новом наборе. 
В обычном случае у нас есть ровно одно развертывание, которое является загруженным, и мы хотим добавить новое развертывание в список. 
Более сложная команда может позволить создать 100 развертываний как часть одной атомарной транзакции, чтобы можно было настроить автоматическую систему для их разделения пополам?. 

### Загрузочная версия

OSTree позволяет переключаться между конфигурациями загрузки, реализуя «шаблон переключения каталогов» в `/boot`. 
Это означает, что это символическая ссылка на один из двух каталогов `/ostree/boot.[0|1]`. 
Чтобы поменять местами содержимое атомарно, если текущая версия равна 0, мы создаем `/ostree/boot.1`, 
заполняем его новым содержимым, а затем атомарно меняем местами символическую ссылку. 
В любой момент старое содержимое может быть удалено сборщиком мусора. 

## Каталог /ostree/boot

Однако мы хотим выполнить оптимизацию для случая, когда набор  `kernel/initramfs/devicetree` одинаков как для старого, так и для нового списков развертывания. 
Это происходит при обновлении без ядра. 
OSTree оптимизируется и для этого случая, потому что в некоторых системах `/boot` может быть на отдельном носителе, таком как флэш-память, не оптимизированная для значительных объемов трафика записи. 
В связи с этим современный OSTree поддерживает монтирование `/boot` по умолчанию только для чтения - оно автоматически перемонтирует чтение-запись только на время, необходимое для обновления конфигурации загрузчика.

Для реализации этого OSTree также поддерживает каталог `/ostree/boot.$bootversion`, который представляет собой набор символических ссылок на каталоги развертывания. 
Здесь `$bootversion` должна соответствовать версии `/boot`. 
Однако, чтобы разрешить атомарные переходы этого каталога, это также переключаемый каталог, поэтому, как и  в `/boot`, к нему добавлены версии 0 или 1.

Каждая запись загрузчика имеет специальный аргумент `ostree=`, который ссылается на одну из этих символических ссылок. 
Это анализируется во время выполнения в initramfs. 
